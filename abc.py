import osimport sqlite3import zipfileimport reimport htmlimport textwrapimport threadingfrom kivymd.app import MDAppfrom kivy.lang import Builderfrom kivymd.uix.screen import MDScreenfrom kivymd.uix.list import OneLineListItemfrom kivymd.toast import toastfrom kivy.clock import Clockfrom kivy.utils import platform# --- CẤU HÌNH ---CHUNK_SIZE = 3500# --- HÀM ĐỌC DOCX (GIỮ NGUYÊN) ---def docx_to_text_smart(path):    try:        if not zipfile.is_zipfile(path): return ""        with zipfile.ZipFile(path) as z:            content = z.read('word/document.xml').decode('utf-8')            content = re.sub(r'</w:p>', '\n\n', content)            content = re.sub(r'<w:br/>', '\n', content)            content = re.sub(r'<[^>]+>', '', content)            content = html.unescape(content)            content = re.sub(r'\n{3,}', '\n\n', content)            return content.strip()    except: return ""# --- GIAO DIỆN ---KV = '''ScreenManager:    HomeScreen:    ReadScreen:    ChapterScreen:  # <-- MÀN HÌNH MỚI<HomeScreen>:    name: 'home'    md_bg_color: 0.1, 0.1, 0.1, 1        MDBoxLayout:        orientation: 'vertical'                MDTopAppBar:            title: "Tủ Truyện"            md_bg_color: 0.2, 0.2, 0.2, 1            right_action_items: [["refresh", lambda x: app.start_scan()]]        MDBoxLayout:            orientation: 'vertical'            padding: 10            adaptive_height: True                        MDLabel:                text: "Chép file vào Download -> Bấm Refresh"                halign: "center"                theme_text_color: "Custom"                text_color: 0.6, 0.6, 0.6, 1                font_style: "Caption"                        MDSpinner:                id: loading_spinner                size_hint: None, None                size: "30dp", "30dp"                pos_hint: {'center_x': .5}                active: False                color: 1, 1, 1, 1        MDScrollView:            MDList:                id: story_list<ChapterScreen>:    name: 'chapters'    md_bg_color: 0, 0, 0, 1 # Nền ĐEN TUYỀN        MDBoxLayout:        orientation: 'vertical'                MDTopAppBar:            title: "Chọn Chương"            md_bg_color: 0.1, 0.1, 0.1, 1            # Nút Quay lại màn hình Đọc            left_action_items: [["arrow-left", lambda x: app.back_to_read()]]                    MDScrollView:            MDList:                id: chapter_list_container<ReadScreen>:    name: 'read'    md_bg_color: 0, 0, 0, 1        MDBoxLayout:        orientation: 'vertical'                MDTopAppBar:            id: read_toolbar            title: "Đọc Truyện"            md_bg_color: 0.1, 0.1, 0.1, 1                        # Nút Back về trang chủ            left_action_items: [["home", lambda x: app.switch_to_home()]]                        # Nút CHUYỂN MÀN HÌNH DANH SÁCH (Không dùng Dialog nữa)            right_action_items: [["format-list-bulleted", lambda x: app.switch_to_chapter_screen()]]                    MDScrollView:            id: scroll_view            do_scroll_x: False            do_scroll_y: True                        MDLabel:                id: read_content                text: ""                adaptive_height: True                padding: [15, 20]                markup: True                font_style: "Body1"                font_size: "19sp"                line_height: 1.5                theme_text_color: "Custom"                text_color: 0.9, 0.9, 0.9, 1                text_size: self.width, None        MDBoxLayout:            size_hint_y: None            height: "50dp"            md_bg_color: 0.15, 0.15, 0.15, 1            padding: [10, 0]                        MDIconButton:                icon: "chevron-left"                theme_text_color: "Custom"                text_color: 1, 1, 1, 1                on_release: app.prev_page()                            MDLabel:                id: page_label                text: "Trang 1 / 1"                halign: "center"                theme_text_color: "Custom"                text_color: 1, 1, 1, 1                font_style: "Caption"                            MDIconButton:                icon: "chevron-right"                theme_text_color: "Custom"                text_color: 1, 1, 1, 1                on_release: app.next_page()'''class HomeScreen(MDScreen): passclass ReadScreen(MDScreen): passclass ChapterScreen(MDScreen): pass # Class mới cho màn hình danh sách# Item Danh Sách (Chữ Trắng - Nền Đen)class WhiteListItem(OneLineListItem):    def __init__(self, **kwargs):        super().__init__(**kwargs)        self.theme_text_color = "Custom"        self.text_color = (1, 1, 1, 1) # MÀU TRẮNG        self.bg_color = (0, 0, 0, 1)   # Nền Đen        # Thêm đường kẻ mờ bên dưới cho dễ nhìn        self.divider = "Full"        self.divider_color = (0.3, 0.3, 0.3, 1)class MyStoryApp(MDApp):    current_pages = []     current_page_index = 0    current_story_id = None # Nhớ ID truyện đang đọc    def build(self):        self.theme_cls.theme_style = "Dark"                if platform == 'android':            self.input_folder = "/storage/emulated/0/Download"        else:            self.input_folder = os.path.join(os.path.expanduser("~"), "Downloads")        app_path = os.path.dirname(os.path.abspath(__file__))        self.conn = sqlite3.connect(os.path.join(app_path, "truyen_v9.db"), check_same_thread=False)        self.cursor = self.conn.cursor()        self.cursor.execute("CREATE TABLE IF NOT EXISTS stories (id INTEGER PRIMARY KEY, title TEXT, content TEXT)")        self.conn.commit()                return Builder.load_string(KV)    def on_start(self):        self.refresh_home_ui()        # Load sẵn danh sách chương vào màn hình phụ để lát mở cho nhanh        self.load_all_chapters_to_screen()    # --- QUÉT FILE ---    def start_scan(self):        self.root.get_screen('home').ids.loading_spinner.active = True        threading.Thread(target=self.scan_process).start()    def scan_process(self):        if not os.path.exists(self.input_folder):            self.stop_spinner("Lỗi: Không tìm thấy folder Download")            return        files = [f for f in os.listdir(self.input_folder) if f.endswith('.docx')]        if not files:            self.stop_spinner("Không có file .docx nào")            return        count = 0        new_data = []        for filename in files:            try:                full_path = os.path.join(self.input_folder, filename)                title = filename.replace(".docx", "")                self.cursor.execute("SELECT id FROM stories WHERE title = ?", (title,))                if self.cursor.fetchone() is None:                    content = docx_to_text_smart(full_path)                    if len(content) > 10:                        new_data.append((title, content))                        count += 1            except: pass        if new_data:            self.cursor.executemany("INSERT INTO stories (title, content) VALUES (?, ?)", new_data)            self.conn.commit()        Clock.schedule_once(lambda dt: self.finish_scan_ui(count))    def finish_scan_ui(self, count):        self.refresh_home_ui()        self.load_all_chapters_to_screen() # Cập nhật luôn màn hình danh sách        self.root.get_screen('home').ids.loading_spinner.active = False        if count > 0: toast(f"Đã thêm {count} truyện")        else: toast("Không có truyện mới")    def stop_spinner(self, msg):        Clock.schedule_once(lambda dt: self._stop_spinner_thread(msg))    def _stop_spinner_thread(self, msg):        self.root.get_screen('home').ids.loading_spinner.active = False        toast(msg)    def refresh_home_ui(self):        lst = self.root.get_screen('home').ids.story_list        lst.clear_widgets()        self.cursor.execute("SELECT id, title FROM stories ORDER BY title ASC")        rows = self.cursor.fetchall()        for row in rows:            # Ở màn hình Home dùng item nền xám nhẹ            item = OneLineListItem(                text=row[1],                theme_text_color="Custom",                text_color=(1, 1, 1, 1),                bg_color=(0.15, 0.15, 0.15, 1)            )            item.bind(on_release=lambda x, sid=row[0]: self.open_story(sid))            lst.add_widget(item)    # --- TỐI ƯU: LOAD DANH SÁCH CHƯƠNG VÀO MÀN HÌNH RIÊNG ---    def load_all_chapters_to_screen(self):        # Hàm này chạy ngầm để tạo sẵn danh sách        threading.Thread(target=self._load_chapters_background).start()    def _load_chapters_background(self):        self.cursor.execute("SELECT id, title FROM stories ORDER BY title ASC")        rows = self.cursor.fetchall()        Clock.schedule_once(lambda dt: self._update_chapter_screen(rows))    def _update_chapter_screen(self, rows):        screen = self.root.get_screen('chapters')        lst = screen.ids.chapter_list_container        lst.clear_widgets()                for row in rows:            # Dùng WhiteListItem (Chữ trắng - Nền đen)            item = WhiteListItem(text=row[1])            # Khi chọn chương từ đây -> Mở truyện -> Tự về màn hình đọc            item.bind(on_release=lambda x, sid=row[0]: self.open_story(sid))            lst.add_widget(item)    def switch_to_chapter_screen(self):        # Chuyển màn hình thay vì bật Dialog -> MƯỢT HƠN RẤT NHIỀU        self.root.transition.direction = 'left'        self.root.current = 'chapters'    def back_to_read(self):        # Nút quay lại từ danh sách        if self.current_story_id:            self.root.transition.direction = 'right'            self.root.current = 'read'        else:            self.switch_to_home()    # --- ĐỌC & PHÂN TRANG ---    def open_story(self, sid):        self.current_story_id = sid        self.cursor.execute("SELECT title, content FROM stories WHERE id=?", (sid,))        data = self.cursor.fetchone()                if data:            title = data[0]            full_content = data[1]                        if len(full_content) > CHUNK_SIZE:                self.current_pages = textwrap.wrap(full_content, CHUNK_SIZE, replace_whitespace=False, drop_whitespace=False)            else:                self.current_pages = [full_content]                        self.current_page_index = 0                        scr = self.root.get_screen('read')            scr.ids.read_toolbar.title = title            self.update_page_display()            self.root.current = 'read'    def update_page_display(self):        scr = self.root.get_screen('read')        page_content = self.current_pages[self.current_page_index]        scr.ids.read_content.text = page_content        scr.ids.scroll_view.scroll_y = 1         scr.ids.page_label.text = f"Trang {self.current_page_index + 1} / {len(self.current_pages)}"    def next_page(self):        if self.current_page_index < len(self.current_pages) - 1:            self.current_page_index += 1            self.update_page_display()        else:            # Gợi ý: Hết chương có thể hỏi chuyển chương tiếp theo (tính năng nâng cao)            toast("Hết chương này.")    def prev_page(self):        if self.current_page_index > 0:            self.current_page_index -= 1            self.update_page_display()    def switch_to_home(self):        self.root.transition.direction = 'right'        self.root.current = 'home'if __name__ == '__main__':    MyStoryApp().run()